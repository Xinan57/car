<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCare Pro - KFZ Verwaltung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--white);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: var(--light);
            color: var(--dark);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .garage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .car-card {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }

        .car-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .car-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            margin-bottom: 20px;
        }

        .car-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .car-details {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .car-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat {
            background: var(--light);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .workshop-finder {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .workshop-card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .workshop-card:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .workshop-logo {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .workshop-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .service-list {
            list-style: none;
            text-align: left;
            margin-top: 15px;
        }

        .service-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-list li:before {
            content: "‚úì";
            color: var(--success);
            font-weight: bold;
        }

        .checkbook-entry {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .checkbook-entry:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .entry-date {
            font-weight: 700;
            color: var(--primary);
        }

        .entry-type {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .costs-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .cost-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .cost-amount {
            font-size: 32px;
            font-weight: 800;
            margin: 10px 0;
        }

        .chart-container {
            height: 300px;
            background: var(--light);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
        }

        .reminder-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .fuel-tracker {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .fuel-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .garage-grid, .workshop-finder, .form-row {
                grid-template-columns: 1fr;
            }
            
            nav {
                flex-wrap: wrap;
            }
            
            .nav-btn {
                font-size: 14px;
                padding: 8px 12px;
            }
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .car-card:hover .delete-btn {
            opacity: 1;
        }

        .document-upload {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-upload:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--dark);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: none;
            animation: slideIn 0.3s;
            z-index: 2000;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .toast.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <div class="logo-icon">üöó</div>
                <span>AutoCare Pro</span>
            </div>
            <nav>
                <button class="nav-btn active" onclick="showSection('garage')">
                    <span>üè†</span> Garage
                </button>
                <button class="nav-btn" onclick="showSection('workshop')">
                    <span>üîß</span> Werkstatt
                </button>
                <button class="nav-btn" onclick="showSection('checkbook')">
                    <span>üìã</span> Checkheft
                </button>
                <button class="nav-btn" onclick="showSection('costs')">
                    <span>üí∞</span> Kosten
                </button>
            </nav>
        </header>

        <!-- Garage Section -->
        <section id="garage" class="section active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Meine Garage</h2>
                    <button class="btn btn-primary" onclick="openModal('addCarModal')">
                        <span>+</span> Auto hinzuf√ºgen
                    </button>
                </div>
                <div id="garageGrid" class="garage-grid">
                    <!-- Cars will be inserted here -->
                </div>
            </div>
        </section>

        <!-- Workshop Section -->
        <section id="workshop" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Werkstatt-Finder</h2>
                </div>
                <div class="workshop-finder">
                    <div class="workshop-card" onclick="findWorkshops('atu')">
                        <div class="workshop-logo">üîµ</div>
                        <div class="workshop-name">ATU</div>
                        <p>Auto-Teile-Unger</p>
                        <ul class="service-list">
                            <li>Inspektion & Wartung</li>
                            <li>Reifenservice</li>
                            <li>Klimaservice</li>
                            <li>Diagnose & Reparatur</li>
                        </ul>
                        <button class="btn btn-primary" style="margin-top: 15px; width: 100%;">
                            Filiale suchen
                        </button>
                    </div>
                    <div class="workshop-card" onclick="findWorkshops('pitstop')">
                        <div class="workshop-logo">üî¥</div>
                        <div class="workshop-name">PIT STOP</div>
                        <p>Reifen & Autoservice</p>
                        <ul class="service-list">
                            <li>Reifenwechsel</li>
                            <li>√ñlwechsel</li>
                            <li>Bremsenservice</li>
                            <li>Achsmessung</li>
                        </ul>
                        <button class="btn btn-primary" style="margin-top: 15px; width: 100%;">
                            Filiale suchen
                        </button>
                    </div>
                </div>
                <div id="workshopResults" style="margin-top: 30px;"></div>
            </div>
        </section>

        <!-- Checkbook Section -->
        <section id="checkbook" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Digitales Checkheft</h2>
                    <select id="carSelectCheckbook" class="btn btn-secondary" onchange="loadCheckbook()">
                        <option value="">Fahrzeug w√§hlen...</option>
                    </select>
                </div>
                <div id="checkbookContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìñ</div>
                        <h3>W√§hle ein Fahrzeug aus</h3>
                        <p>Um das Checkheft zu sehen, w√§hle bitte ein Auto aus deiner Garage.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Costs Section -->
        <section id="costs" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Kosten√ºbersicht</h2>
                    <select id="carSelectCosts" class="btn btn-secondary" onchange="loadCosts()">
                        <option value="">Alle Fahrzeuge</option>
                    </select>
                </div>
                <div class="costs-summary" id="costsSummary">
                    <div class="cost-card">
                        <div>Gesamtkosten</div>
                        <div class="cost-amount" id="totalCosts">0 ‚Ç¨</div>
                        <div>Seit Kauf</div>
                    </div>
                    <div class="cost-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <div>Dieses Jahr</div>
                        <div class="cost-amount" id="yearCosts">0 ‚Ç¨</div>
                        <div>2024</div>
                    </div>
                    <div class="cost-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div>√ò pro km</div>
                        <div class="cost-amount" id="costPerKm">0 ‚Ç¨</div>
                        <div>Laufende Kosten</div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 20px;">Kostenverteilung</h3>
                <div class="chart-container" id="costChart">
                    <canvas id="costsCanvas" width="600" height="300"></canvas>
                </div>

                <div class="fuel-tracker">
                    <h3>‚õΩ Spritverbrauch-Tracker</h3>
                    <div class="fuel-stats">
                        <div>
                            <div style="font-size: 24px; font-weight: bold;" id="avgConsumption">-- l/100km</div>
                            <div>Durchschnitt</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;" id="lastConsumption">-- l/100km</div>
                            <div>Letzte Tankf√ºllung</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;" id="totalFuel">-- L</div>
                            <div>Gesamt getankt</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Car Modal -->
    <div id="addCarModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px;">Neues Fahrzeug hinzuf√ºgen</h2>
            <form id="addCarForm" onsubmit="saveCar(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Marke *</label>
                        <select id="carBrand" required onchange="updateModels()">
                            <option value="">Marke w√§hlen...</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes">Mercedes-Benz</option>
                            <option value="VW">Volkswagen</option>
                            <option value="Opel">Opel</option>
                            <option value="Ford">Ford</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Andere">Andere...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Modell *</label>
                        <input type="text" id="carModel" placeholder="z.B. Golf GTI" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Baujahr *</label>
                        <input type="number" id="carYear" min="1900" max="2025" placeholder="2020" required>
                    </div>
                    <div class="form-group">
                        <label>Kennzeichen</label>
                        <input type="text" id="carPlate" placeholder="M-XX 1234">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Motorisierung</label>
                        <input type="text" id="carEngine" placeholder="z.B. 2.0 TDI">
                    </div>
                    <div class="form-group">
                        <label>Leistung (PS)</label>
                        <input type="number" id="carPower" placeholder="150">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Kilometerstand *</label>
                        <input type="number" id="carMileage" placeholder="50000" required>
                    </div>
                    <div class="form-group">
                        <label>N√§chste T√úV</label>
                        <input type="date" id="carTuv">
                    </div>
                </div>

                <div class="form-group">
                    <label>Fahrzeug-Identifikationsnummer (VIN)</label>
                    <input type="text" id="carVin" placeholder="WVWZZZ1JZ3W386752">
                </div>

                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="button" class="btn" onclick="closeModal('addCarModal')" style="flex: 1; background: #e5e7eb;">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Service Entry Modal -->
    <div id="addServiceModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px;">Service-Eintrag hinzuf√ºgen</h2>
            <form id="addServiceForm" onsubmit="saveServiceEntry(event)">
                <input type="hidden" id="serviceCarId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Datum *</label>
                        <input type="date" id="serviceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Kilometerstand *</label>
                        <input type="number" id="serviceMileage" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Service-Art *</label>
                    <select id="serviceType" required>
                        <option value="inspektion">Inspektion</option>
                        <option value="oelwechsel">√ñlwechsel</option>
                        <option value="reifen">Reifenwechsel</option>
                        <option value="bremsen">Bremsenservice</option>
                        <option value="tuev">T√úV/HU</option>
                        <option value="reparatur">Reparatur</option>
                        <option value="sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Beschreibung</label>
                    <textarea id="serviceDesc" rows="3" placeholder="Was wurde gemacht?"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Kosten (‚Ç¨)</label>
                        <input type="number" id="serviceCost" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Werkstatt</label>
                        <input type="text" id="serviceWorkshop" placeholder="z.B. ATU M√ºnchen">
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="button" class="btn" onclick="closeModal('addServiceModal')" style="flex: 1; background: #e5e7eb;">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Data Storage
        let cars = JSON.parse(localStorage.getItem('cars')) || [];
        let serviceEntries = JSON.parse(localStorage.getItem('serviceEntries')) || [];
        let fuelEntries = JSON.parse(localStorage.getItem('fuelEntries')) || [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderGarage();
            updateCarSelects();
            
            // Set today's date as default
            document.getElementById('serviceDate').valueAsDate = new Date();
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.closest('.nav-btn').classList.add('active');
            
            if (sectionId === 'checkbook') loadCheckbook();
            if (sectionId === 'costs') loadCosts();
        }

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Car Management
        function saveCar(event) {
            event.preventDefault();
            
            const car = {
                id: Date.now(),
                brand: document.getElementById('carBrand').value,
                model: document.getElementById('carModel').value,
                year: parseInt(document.getElementById('carYear').value),
                plate: document.getElementById('carPlate').value,
                engine: document.getElementById('carEngine').value,
                power: parseInt(document.getElementById('carPower').value) || 0,
                mileage: parseInt(document.getElementById('carMileage').value),
                tuv: document.getElementById('carTuv').value,
                vin: document.getElementById('carVin').value,
                added: new Date().toISOString()
            };
            
            cars.push(car);
            localStorage.setItem('cars', JSON.stringify(cars));
            
            // Create initial T√úV entry if provided
            if (car.tuv) {
                serviceEntries.push({
                    id: Date.now() + 1,
                    carId: car.id,
                    date: car.tuv,
                    mileage: car.mileage,
                    type: 'tuev',
                    desc: 'T√úV/Hauptuntersuchung',
                    cost: 0,
                    workshop: ''
                });
                localStorage.setItem('serviceEntries', JSON.stringify(serviceEntries));
            }
            
            renderGarage();
            updateCarSelects();
            closeModal('addCarModal');
            document.getElementById('addCarForm').reset();
            showToast('Fahrzeug erfolgreich hinzugef√ºgt!');
        }

        function deleteCar(id) {
            if (confirm('M√∂chtest du dieses Fahrzeug wirklich l√∂schen? Alle dazugeh√∂rigen Daten werden entfernt.')) {
                cars = cars.filter(c => c.id !== id);
                serviceEntries = serviceEntries.filter(e => e.carId !== id);
                fuelEntries = fuelEntries.filter(f => f.carId !== id);
                
                localStorage.setItem('cars', JSON.stringify(cars));
                localStorage.setItem('serviceEntries', JSON.stringify(serviceEntries));
                localStorage.setItem('fuelEntries', JSON.stringify(fuelEntries));
                
                renderGarage();
                updateCarSelects();
                showToast('Fahrzeug gel√∂scht');
            }
        }

        function renderGarage() {
            const grid = document.getElementById('garageGrid');
            
            if (cars.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">üèéÔ∏è</div>
                        <h3>Deine Garage ist leer</h3>
                        <p>F√ºge dein erstes Fahrzeug hinzu, um loszulegen.</p>
                        <button class="btn btn-primary" onclick="openModal('addCarModal')" style="margin-top: 20px;">
                            Auto hinzuf√ºgen
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = cars.map(car => {
                const entries = serviceEntries.filter(e => e.carId === car.id);
                const totalCosts = entries.reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
                const nextTuv = car.tuv ? new Date(car.tuv) : null;
                const today = new Date();
                const tuvWarning = nextTuv && (nextTuv - today) < (30 * 24 * 60 * 60 * 1000); // 30 days warning
                
                return `
                    <div class="car-card">
                        <button class="delete-btn" onclick="deleteCar(${car.id})">√ó</button>
                        ${tuvWarning ? '<div class="reminder-badge">!</div>' : ''}
                        <div class="car-image">üöó</div>
                        <div class="car-name">${car.brand} ${car.model}</div>
                        <div class="car-details">
                            ${car.year} ‚Ä¢ ${car.engine || 'k.A.'} ‚Ä¢ ${car.power || '?'} PS<br>
                            ${car.plate || 'Kein Kennzeichen'}
                        </div>
                        <div class="car-stats">
                            <div class="stat">
                                <div class="stat-value">${car.mileage.toLocaleString()}</div>
                                <div class="stat-label">km</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${entries.length}</div>
                                <div class="stat-label">Services</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${totalCosts.toFixed(0)}‚Ç¨</div>
                                <div class="stat-label">Kosten</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${car.tuv ? new Date(car.tuv).toLocaleDateString('de-DE', {month:'2-digit', year:'2-digit'}) : '--'}</div>
                                <div class="stat-label">T√úV</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" 
                                onclick="openServiceModal(${car.id})">
                            + Service eintragen
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateCarSelects() {
            const options = cars.map(c => `<option value="${c.id}">${c.brand} ${c.model}</option>`).join('');
            document.getElementById('carSelectCheckbook').innerHTML = '<option value="">Fahrzeug w√§hlen...</option>' + options;
            document.getElementById('carSelectCosts').innerHTML = '<option value="">Alle Fahrzeuge</option>' + options;
        }

        // Service/Checkbook Management
        function openServiceModal(carId) {
            document.getElementById('serviceCarId').value = carId;
            const car = cars.find(c => c.id === carId);
            document.getElementById('serviceMileage').value = car ? car.mileage : '';
            openModal('addServiceModal');
        }

        function saveServiceEntry(event) {
            event.preventDefault();
            
            const entry = {
                id: Date.now(),
                carId: parseInt(document.getElementById('serviceCarId').value),
                date: document.getElementById('serviceDate').value,
                mileage: parseInt(document.getElementById('serviceMileage').value),
                type: document.getElementById('serviceType').value,
                desc: document.getElementById('serviceDesc').value,
                cost: parseFloat(document.getElementById('serviceCost').value) || 0,
                workshop: document.getElementById('serviceWorkshop').value
            };
            
            serviceEntries.push(entry);
            
            // Update car mileage if higher
            const car = cars.find(c => c.id === entry.carId);
            if (car && entry.mileage > car.mileage) {
                car.mileage = entry.mileage;
                localStorage.setItem('cars', JSON.stringify(cars));
                renderGarage();
            }
            
            localStorage.setItem('serviceEntries', JSON.stringify(serviceEntries));
            closeModal('addServiceModal');
            document.getElementById('addServiceForm').reset();
            
            if (document.getElementById('checkbook').classList.contains('active')) {
                loadCheckbook();
            }
            showToast('Service-Eintrag gespeichert!');
        }

        function loadCheckbook() {
            const carId = document.getElementById('carSelectCheckbook').value;
            const container = document.getElementById('checkbookContent');
            
            if (!carId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìñ</div>
                        <h3>W√§hle ein Fahrzeug aus</h3>
                        <p>Um das Checkheft zu sehen, w√§hle bitte ein Auto aus deiner Garage.</p>
                    </div>
                `;
                return;
            }
            
            const car = cars.find(c => c.id === parseInt(carId));
            const entries = serviceEntries
                .filter(e => e.carId === parseInt(carId))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const typeLabels = {
                'inspektion': 'üîß Inspektion',
                'oelwechsel': 'üõ¢Ô∏è √ñlwechsel',
                'reifen': 'üöó Reifenwechsel',
                'bremsen': 'üõë Bremsenservice',
                'tuev': '‚úì T√úV/HU',
                'reparatur': 'üî© Reparatur',
                'sonstiges': 'üìã Sonstiges'
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>${car.brand} ${car.model}</h3>
                    <button class="btn btn-primary" onclick="openServiceModal(${car.id})">
                        + Neuer Eintrag
                    </button>
                </div>
                ${entries.length === 0 ? '<p>Noch keine Eintr√§ge vorhanden.</p>' : 
                    entries.map(e => `
                        <div class="checkbook-entry">
                            <div class="entry-header">
                                <span class="entry-date">${new Date(e.date).toLocaleDateString('de-DE')}</span>
                                <span class="entry-type">${typeLabels[e.type] || e.type}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>${e.mileage.toLocaleString()} km</strong>
                                ${e.workshop ? `‚Ä¢ ${e.workshop}` : ''}
                            </div>
                            ${e.desc ? `<div style="color: #6b7280; margin-bottom: 10px;">${e.desc}</div>` : ''}
                            ${e.cost > 0 ? `<div style="font-weight: bold; color: var(--primary);">${e.cost.toFixed(2)} ‚Ç¨</div>` : ''}
                        </div>
                    `).join('')}
            `;
        }

        // Costs Analysis
        function loadCosts() {
            const carId = document.getElementById('carSelectCosts').value;
            
            let relevantEntries = serviceEntries;
            if (carId) {
                relevantEntries = serviceEntries.filter(e => e.carId === parseInt(carId));
            }
            
            const totalCosts = relevantEntries.reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
            
            const thisYear = new Date().getFullYear();
            const yearCosts = relevantEntries
                .filter(e => new Date(e.date).getFullYear() === thisYear)
                .reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
            
            // Calculate cost per km
            let costPerKm = 0;
            if (carId) {
                const car = cars.find(c => c.id === parseInt(carId));
                const fuelCosts = fuelEntries
                    .filter(f => f.carId === parseInt(carId))
                    .reduce((sum, f) => sum + (parseFloat(f.cost) || 0), 0);
                const totalAllCosts = totalCosts + fuelCosts;
                
                if (car && car.mileage > 0) {
                    costPerKm = totalAllCosts / car.mileage;
                }
            }
            
            document.getElementById('totalCosts').textContent = totalCosts.toFixed(0) + ' ‚Ç¨';
            document.getElementById('yearCosts').textContent = yearCosts.toFixed(0) + ' ‚Ç¨';
            document.getElementById('costPerKm').textContent = costPerKm.toFixed(2) + ' ‚Ç¨';
            
            drawCostChart(relevantEntries);
            updateFuelStats(carId);
        }

        function drawCostChart(entries) {
            const canvas = document.getElementById('costsCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Group by type
            const costsByType = {};
            entries.forEach(e => {
                costsByType[e.type] = (costsByType[e.type] || 0) + (parseFloat(e.cost) || 0);
            });
            
            const types = Object.keys(costsByType);
            const values = Object.values(costsByType);
            const total = values.reduce((a, b) => a + b, 0);
            
            if (total === 0) {
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Keine Kostendaten verf√ºgbar', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Draw pie chart
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 100;
            
            const colors = ['#2563eb', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
            let currentAngle = 0;
            
            types.forEach((type, i) => {
                const sliceAngle = (values[i] / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                
                // Label
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
                
                ctx.fillStyle = '#1f2937';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(type, labelX, labelY);
                ctx.fillText(values[i].toFixed(0) + '‚Ç¨', labelX, labelY + 15);
                
                currentAngle += sliceAngle;
            });
        }

        function updateFuelStats(carId) {
            if (!carId) {
                document.getElementById('avgConsumption').textContent = '-- l/100km';
                document.getElementById('lastConsumption').textContent = '-- l/100km';
                document.getElementById('totalFuel').textContent = '-- L';
                return;
            }
            
            const entries = fuelEntries.filter(f => f.carId === parseInt(carId));
            
            if (entries.length === 0) {
                document.getElementById('avgConsumption').textContent = '-- l/100km';
                document.getElementById('lastConsumption').textContent = '-- l/100km';
                document.getElementById('totalFuel').textContent = '-- L';
                return;
            }
            
            const totalLiters = entries.reduce((sum, e) => sum + e.liters, 0);
            const avgConsumption = entries.reduce((sum, e) => sum + e.consumption, 0) / entries.length;
            const lastConsumption = entries[entries.length - 1].consumption;
            
            document.getElementById('avgConsumption').textContent = avgConsumption.toFixed(1) + ' l/100km';
            document.getElementById('lastConsumption').textContent = lastConsumption.toFixed(1) + ' l/100km';
            document.getElementById('totalFuel').textContent = totalLiters.toFixed(0) + ' L';
        }

        // Workshop Finder
        function findWorkshops(type) {
            const results = document.getElementById('workshopResults');
            
            // Simulated workshop data
            const workshops = type === 'atu' ? [
                { name: 'ATU M√ºnchen Sendling', address: 'Meindlstra√üe 12, 81379 M√ºnchen', phone: '089 12345678', distance: '2.3 km' },
                { name: 'ATU M√ºnchen Pasing', address: 'Landsberger Stra√üe 456, 80689 M√ºnchen', phone: '089 87654321', distance: '5.1 km' },
                { name: 'ATU M√ºnchen Nord', address: 'Schlei√üheimer Stra√üe 123, 80809 M√ºnchen', phone: '089 11223344', distance: '8.7 km' }
            ] : [
                { name: 'PIT STOP M√ºnchen West', address: 'Ridlerstra√üe 45, 80339 M√ºnchen', phone: '089 55556666', distance: '3.2 km' },
                { name: 'PIT STOP M√ºnchen Ost', address: 'Einsteinstra√üe 88, 81675 M√ºnchen', phone: '089 77778888', distance: '6.5 km' },
                { name: 'PIT STOP M√ºnchen S√ºd', address: 'Plinganserstra√üe 67, 81369 M√ºnchen', phone: '089 99990000', distance: '4.8 km' }
            ];
            
            results.innerHTML = `
                <h3 style="margin-bottom: 20px;">${type === 'atu' ? 'ATU' : 'PIT STOP'} Filialen in deiner N√§he</h3>
                <div style="display: grid; gap: 15px;">
                    ${workshops.map(w => `
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h4 style="margin-bottom: 5px;">${w.name}</h4>
                                    <p style="color: #6b7280; font-size: 14px;">${w.address}</p>
                                    <p style="color: #6b7280; font-size: 14px;">üìû ${w.phone}</p>
                                </div>
                                <div style="text-align: right;">
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                        ${w.distance}
                                    </span>
                                    <button class="btn btn-primary" style="margin-top: 10px; font-size: 14px; padding: 8px 16px;">
                                        Termin buchen
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Utility
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
